<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Audio Share - Host Control</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-primary: #0a0a0a; --bg-secondary: #111; --bg-tertiary: #1a1a1a;
      --border-primary: #2a2a2a; --border-secondary: #1f1f1f;
      --accent: #6366f1; --accent-hover: #818cf8;
      --text-primary: #f5f5f5; --text-secondary: #a3a3a3; --text-tertiary: #737373;
      --success: #10b981; --danger: #ef4444;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; min-height: 100vh; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    header { text-align: center; padding: 40px 20px; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 16px; margin-bottom: 24px; box-shadow: var(--shadow); }
    header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 8px; background: linear-gradient(135deg, var(--accent), var(--accent-hover)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    header p { color: var(--text-secondary); font-size: 1.1rem; margin-bottom: 20px; }
    .status-bar { display: flex; justify-content: center; gap: 24px; flex-wrap: wrap; margin-top: 20px; }
    .status-item { display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--bg-tertiary); border: 1px solid var(--border-secondary); border-radius: 20px; font-size: 0.9rem; transition: all 0.3s; }
    .status-item:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
    .card { background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: var(--shadow); }
    .card h2 { font-size: 1.5rem; margin-bottom: 16px; color: var(--text-primary); display: flex; align-items: center; gap: 10px; }
    .btn { padding: 12px 24px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); transform: translateY(-2px); box-shadow: var(--shadow); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { background: #dc2626; transform: translateY(-2px); box-shadow: var(--shadow); }
    .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary); }
    .btn-secondary:hover { background: #252525; }
    .controls { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-bottom: 20px; }
    .audio-visualizer { background: var(--bg-tertiary); border: 1px solid var(--border-secondary); border-radius: 10px; height: 60px; margin: 20px 0; position: relative; overflow: hidden; }
    .audio-level-bar { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-hover), var(--success)); width: 0%; transition: width 0.1s ease; border-radius: 10px; }
    .tuning-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 20px 0; padding: 20px; background: var(--bg-tertiary); border: 1px solid var(--border-secondary); border-radius: 10px; }
    .input-group { display: flex; flex-direction: column; gap: 8px; }
    .input-group label { font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); }
    input[type="number"], input[type="text"] { padding: 10px 12px; background: var(--bg-primary); border: 1px solid var(--border-primary); border-radius: 8px; color: var(--text-primary); font-size: 1rem; transition: all 0.3s; font-family: 'Courier New', monospace; }
    input[type="text"] { font-family: inherit; }
    input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
    input[readonly] { cursor: pointer; }
    .share-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
    .share-card { background: var(--bg-tertiary); border: 1px solid var(--border-secondary); border-radius: 12px; padding: 20px; transition: all 0.3s; }
    .share-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); border-color: var(--accent); }
    .share-card h3 { margin-bottom: 8px; font-size: 1.2rem; color: var(--text-secondary); }
    .share-card p { color: var(--text-tertiary); font-size: 0.9rem; margin-bottom: 16px; }
    .url-group { display: flex; gap: 8px; }
    .url-group input { flex: 1; }
    .viewer-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 16px; }
    .viewer-chip { padding: 8px 16px; background: linear-gradient(135deg, var(--bg-tertiary), #1f1f2e); border: 1px solid var(--border-primary); border-radius: 20px; font-family: 'Courier New', monospace; font-size: 0.85rem; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; transition: all 0.3s; }
    .viewer-chip:hover { border-color: var(--accent); color: var(--text-primary); transform: translateY(-2px); }
    .viewer-chip::before { content: ''; color: var(--success); font-size: 1.2rem; }
    .quality-panel { margin-top: 16px; padding: 16px; background: var(--bg-primary); border: 1px solid var(--border-secondary); border-radius: 10px; font-family: 'Courier New', monospace; font-size: 0.85rem; line-height: 1.6; color: var(--text-secondary); white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    .info-box { background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 10px; padding: 16px; margin: 16px 0; }
    .info-box h4 { color: var(--accent-hover); margin-bottom: 12px; font-size: 1rem; }
    .info-box ol { padding-left: 20px; color: var(--text-secondary); }
    .info-box li { margin: 8px 0; }
    .network-grid { display: grid; gap: 12px; margin-top: 12px; }
    .network-item { padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-secondary); border-radius: 8px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; }
    .network-item:hover { border-color: var(--accent); transform: translateX(4px); }
    .network-item strong { color: var(--accent-hover); min-width: 100px; }
    .network-item span { font-family: 'Courier New', monospace; color: var(--text-secondary); }
    .notification { position: fixed; bottom: 24px; right: 24px; padding: 16px 24px; background: var(--bg-secondary); border: 1px solid var(--border-primary); border-radius: 12px; box-shadow: var(--shadow); transform: translateX(400px); transition: transform 0.3s ease; z-index: 1000; display: flex; align-items: center; gap: 12px; max-width: 400px; }
    .notification.show { transform: translateX(0); }
    .notification.success { border-color: var(--success); }
    .notification.error { border-color: var(--danger); }
    .notification::before { content: ''; display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: var(--success); color: white; font-weight: bold; }
    .notification.error::before { content: ''; background: var(--danger); }
    @media (max-width: 768px) { header h1 { font-size: 2rem; } .card { padding: 16px; } .controls { flex-direction: column; width: 100%; } .btn { width: 100%; justify-content: center; } .tuning-grid { grid-template-columns: 1fr; } .share-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1> Live Audio Share</h1>
      <p>Stream your system audio to all devices on your network</p>
      <div class="status-bar">
        <div id="connectionStatus" class="status-item"> Connecting...</div>
        <div id="clientsCount" class="status-item"> 0 listeners</div>
      </div>
    </header>
    <div class="card">
      <h2> Network Information</h2>
      <div id="networkAddresses" class="network-grid"></div>
    </div>
    <div class="card">
      <h2> System Audio Stream</h2>
      <div class="controls">
        <button id="startAudioStream" class="btn btn-primary"> Start Streaming</button>
        <button id="stopAudioStream" class="btn btn-danger" style="display:none;"> Stop Streaming</button>
        <div id="audioStatus" style="color: var(--text-tertiary); margin-left: auto;">Not streaming</div>
      </div>
      <div class="audio-visualizer"><div id="audioLevelBar" class="audio-level-bar"></div></div>
      <div class="tuning-grid">
        <div class="input-group"><label>Latency Target (ms)</label><input type="number" id="latencyInput" value="150" min="80" max="800" step="10" /></div>
        <div class="input-group"><label>Bitrate (kbps) 🎵</label><input type="number" id="bitrateInput" value="256" min="64" max="512" step="16" /></div>
        <div class="input-group"><label>&nbsp;</label><button id="applyTuning" class="btn btn-secondary">Apply Settings</button></div>
      </div>
      <div id="tuneStatus" style="text-align: center; color: var(--text-tertiary); font-size: 0.9rem;">Target: 150ms / 256kbps (ptime 10ms) • High Quality Audio 🎧</div>
      <div class="info-box" style="background: rgba(16, 185, 129, 0.08); border-color: rgba(16, 185, 129, 0.3);"><h4 style="color: var(--success);">🎵 Enhanced Audio Quality</h4><p style="color: var(--text-secondary); margin: 8px 0;">Optimized for music streaming with 256kbps bitrate, 48kHz sample rate, and stereo output. Lower latency (150ms) for near real-time playback.</p></div>
      <div class="info-box"><h4> Quick Start Guide</h4><ol><li>Click "Start Streaming" above</li><li>Select your screen or window to share</li><li><strong>Check "Share audio" or "Share system audio"</strong></li><li>Play any audio on your computer</li><li>Share the listener URL below with others</li></ol></div>
    </div>
    <div class="card">
      <h2> Connected Viewers (<span id="viewerCountInline">0</span>)</h2>
      <div id="viewerList" class="viewer-grid"></div>
      <div id="qualityPanel" class="quality-panel" style="display:none;"></div>
    </div>
    <div class="card">
      <h2> Share Links</h2>
      <div class="share-grid">
        <div class="share-card"><h3> Listener Page</h3><p>Send this to anyone who wants to listen</p><div class="url-group"><input type="text" id="listenUrlInput" readonly /><button id="copyListenUrl" class="btn btn-secondary"></button></div></div>
        <div class="share-card"><h3> Control Page</h3><p>Host control interface (this page)</p><div class="url-group"><input type="text" id="shareUrlInput" readonly /><button id="copyUrl" class="btn btn-secondary"></button></div></div>
      </div>
    </div>
  </div>
  <div id="notification" class="notification"></div>
  <script src="script.js"></script>
  <script>
    (function() {
      const waitForSocket = () => {
        if (!window.socket) { setTimeout(waitForSocket, 100); return; }
        const latestStats = {};
        socket.on('stats', ({ viewerIds, viewerCount }) => {
          const viewerList = document.getElementById('viewerList');
          const viewerCountInline = document.getElementById('viewerCountInline');
          const qualityPanel = document.getElementById('qualityPanel');
          if (!viewerList) return;
          viewerList.innerHTML = '';
          if (viewerIds && viewerIds.length > 0) {
            viewerIds.forEach(id => { const chip = document.createElement('div'); chip.className = 'viewer-chip'; chip.textContent = id.substring(0, 8); chip.title = id; viewerList.appendChild(chip); });
            qualityPanel.style.display = 'block';
          } else { viewerList.innerHTML = '<div style="color: var(--text-tertiary); text-align: center; padding: 20px;">No viewers connected</div>'; qualityPanel.style.display = 'none'; qualityPanel.textContent = ''; }
          if (viewerCountInline) viewerCountInline.textContent = viewerCount || 0;
        });
        socket.on('listener-stats', ({ viewerId, rttMs, jitterMs, bitrateKbps, fractionLoss }) => { latestStats[viewerId] = { rttMs, jitterMs, bitrateKbps, fractionLoss, timestamp: Date.now() }; renderQuality(); });
        function renderQuality() {
          const qualityPanel = document.getElementById('qualityPanel');
          if (!qualityPanel) return;
          const lines = Object.entries(latestStats).sort((a, b) => a[0].localeCompare(b[0])).map(([id, stats]) => { const shortId = id.substring(0, 8); const quality = getQualityIndicator(stats); return quality + ' ' + shortId + '\n   RTT: ' + stats.rttMs + 'ms | Jitter: ' + stats.jitterMs + 'ms | Bitrate: ' + stats.bitrateKbps + 'kbps | Loss: ' + stats.fractionLoss; });
          qualityPanel.textContent = lines.length > 0 ? lines.join('\n\n') : 'Waiting for quality metrics...';
        }
        function getQualityIndicator(stats) { const rtt = parseFloat(stats.rttMs) || 0; const jitter = parseFloat(stats.jitterMs) || 0; const loss = parseFloat(stats.fractionLoss) || 0; if (rtt < 100 && jitter < 10 && loss < 1) return ''; if (rtt < 200 && jitter < 20 && loss < 3) return ''; return ''; }
      };
      waitForSocket();
    })();
  </script>
</body>
</html>
