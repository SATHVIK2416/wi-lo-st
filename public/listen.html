<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>üéß Audio Listener</title>
        <script src="/socket.io/socket.io.js"></script>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            :root {
                --bg-primary: #0a0a0a; --bg-secondary: #111; --bg-tertiary: #1a1a1a;
                --border-primary: #2a2a2a; --border-secondary: #1f1f1f;
                --accent: #6366f1; --accent-hover: #818cf8;
                --text-primary: #f5f5f5; --text-secondary: #a3a3a3; --text-tertiary: #737373;
                --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
                --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            }
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
                background: var(--bg-primary);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--text-primary);
                padding: 20px;
            }
            .listener-container {
                background: var(--bg-secondary);
                padding: 48px 40px;
                border-radius: 24px;
                border: 1px solid var(--border-primary);
                box-shadow: var(--shadow);
                max-width: 600px;
                width: 100%;
                text-align: center;
            }
            h1 {
                font-size: 3rem;
                font-weight: 700;
                margin-bottom: 16px;
                background: linear-gradient(135deg, var(--accent), var(--accent-hover), var(--success));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                letter-spacing: 0.5px;
            }
            .status {
                font-size: 1.3rem;
                margin: 24px 0;
                padding: 16px 20px;
                border-radius: 16px;
                background: var(--bg-tertiary);
                border: 1px solid var(--border-secondary);
                font-weight: 500;
            }
            .connection-status {
                display: flex;
                justify-content: center;
                gap: 16px;
                flex-wrap: wrap;
                margin-bottom: 24px;
            }
            .status-item {
                background: var(--bg-tertiary);
                padding: 10px 18px;
                border-radius: 20px;
                font-size: 0.9rem;
                border: 1px solid var(--border-secondary);
                color: var(--text-secondary);
                transition: all 0.3s;
            }
            .status-item:hover {
                transform: translateY(-2px);
                border-color: var(--accent);
            }
            .audio-visualizer {
                width: 100%;
                height: 80px;
                background: var(--bg-tertiary);
                border-radius: 16px;
                margin: 24px 0;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 2px;
                overflow: hidden;
                border: 1px solid var(--border-secondary);
                padding: 10px;
            }
            .visualizer-bar {
                width: 6px;
                background: linear-gradient(to top, var(--accent), var(--accent-hover), var(--success));
                border-radius: 3px;
                height: 20%;
                transition: height 0.15s ease;
            }
            .volume-control {
                margin: 24px 0;
                padding: 20px;
                background: var(--bg-tertiary);
                border: 1px solid var(--border-secondary);
                border-radius: 16px;
            }
            .volume-control label {
                font-size: 0.9rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: var(--text-secondary);
                margin-bottom: 12px;
                display: block;
            }
            .volume-slider {
                width: 100%;
                height: 8px;
                border-radius: 4px;
                background: var(--bg-primary);
                outline: none;
                appearance: none;
                -webkit-appearance: none;
                border: 1px solid var(--border-primary);
                margin: 12px 0;
            }
            .volume-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: var(--accent);
                cursor: pointer;
                box-shadow: 0 0 0 4px var(--bg-secondary);
                transition: all 0.3s;
            }
            .volume-slider::-webkit-slider-thumb:hover {
                background: var(--accent-hover);
                transform: scale(1.1);
            }
            .volume-slider::-moz-range-thumb {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: var(--accent);
                cursor: pointer;
                border: none;
                box-shadow: 0 0 0 4px var(--bg-secondary);
            }
            #volumeDisplay {
                font-size: 1.2rem;
                font-weight: 600;
                color: var(--accent-hover);
                margin-top: 8px;
            }
            .controls {
                display: flex;
                gap: 12px;
                justify-content: center;
                flex-wrap: wrap;
                margin: 20px 0;
            }
            .btn {
                background: var(--accent);
                color: white;
                border: none;
                padding: 14px 32px;
                border-radius: 12px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                min-width: 160px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }
            .btn:hover {
                background: var(--accent-hover);
                transform: translateY(-2px);
                box-shadow: var(--shadow);
            }
            .info-text {
                font-size: 0.9rem;
                line-height: 1.6;
                margin-top: 24px;
                color: var(--text-secondary);
                padding: 16px;
                background: rgba(99, 102, 241, 0.05);
                border: 1px solid rgba(99, 102, 241, 0.2);
                border-radius: 12px;
            }
            a {
                color: var(--accent-hover);
                text-decoration: none;
                transition: all 0.3s;
            }
            a:hover {
                color: var(--accent);
                text-decoration: underline;
            }
            .notification {
                position: fixed;
                bottom: 24px;
                right: 24px;
                background: var(--bg-secondary);
                padding: 16px 24px;
                border-radius: 12px;
                border: 1px solid var(--border-primary);
                transform: translateX(400px);
                transition: transform 0.3s ease;
                font-size: 0.9rem;
                box-shadow: var(--shadow);
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 12px;
            }
            .notification.show { transform: translateX(0); }
            .notification.success {
                border-color: var(--success);
                color: var(--success);
            }
            .notification.error {
                border-color: var(--danger);
                color: var(--danger);
            }
            .notification::before {
                content: '‚úì';
                display: flex;
                align-items: center;
                justify-content: center;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                background: var(--success);
                color: white;
                font-weight: bold;
            }
            .notification.error::before {
                content: '‚úó';
                background: var(--danger);
            }
            @media (max-width: 640px) {
                h1 { font-size: 2.2rem; }
                .listener-container { padding: 32px 24px; }
                .controls { flex-direction: column; }
                .btn { width: 100%; }
            }
        </style>
    </head>
    <body>
        <div class="listener-container">
            <h1>üéß Audio Listener</h1>
            <div id="audioStatus" class="status">üîá Waiting for audio stream...</div>
            <div class="connection-status">
                <div id="connectionStatus" class="status-item">üîå Connecting...</div>
                <div id="clientsCount" class="status-item">üë• 0 listening</div>
                <div id="qualityStats" class="status-item" style="min-width:140px;">‚è±Ô∏è ‚Ä¶</div>
            </div>
            <div id="audioVisualizer" class="audio-visualizer"></div>
            <div class="volume-control">
                <label for="volumeSlider">üîä Volume</label><br />
                <input id="volumeSlider" type="range" class="volume-slider" min="0" max="100" value="100" />
                <div id="volumeDisplay">100%</div>
            </div>
            <div class="controls">
                <button id="enableAudio" class="btn">üîä Enable Audio</button>
                <button id="muteAudio" class="btn" style="display:none;">üîá Mute</button>
            </div>
            <div class="info-text">Ensure you're on the same WiFi as the host. Press Enable to join the live system audio stream.</div>
            <div class="info-text" style="margin-top:28px"><a href="/">‚Üê Back to Main App</a></div>
        </div>
        <div id="notification" class="notification"></div>
        <script>
            let socket, pc, audioEl, hostIdRef = null; const bars = []; let muted = false, volume = 1.0;
            const qs = id => document.getElementById(id);
            const audioStatus = qs('audioStatus'), connectionStatus = qs('connectionStatus'), clientsCount = qs('clientsCount'), vis = qs('audioVisualizer'), volumeSlider = qs('volumeSlider'), volumeDisplay = qs('volumeDisplay'), enableBtn = qs('enableAudio'), muteBtn = qs('muteAudio'), note = qs('notification'), qualityStats = qs('qualityStats');
            document.addEventListener('DOMContentLoaded', () => { initBars(); initSocket(); bindUi(); });
            function initBars(){ for(let i=0;i<40;i++){ const b=document.createElement('div'); b.className='visualizer-bar'; vis.appendChild(b); bars.push(b);} }
            function bindUi(){ volumeSlider.addEventListener('input', () => { volume = volumeSlider.value/100; volumeDisplay.textContent = volumeSlider.value + '%'; if(audioEl) audioEl.volume = volume; }); enableBtn.addEventListener('click', joinStream); muteBtn.addEventListener('click', toggleMute); }
            function initSocket(){ socket = io(); socket.on('connect', () => { connectionStatus.textContent='üü¢ Connected'; connectionStatus.style.color='#38a169'; }); socket.on('disconnect', () => { connectionStatus.textContent='üî¥ Disconnected'; connectionStatus.style.color='#e53e3e'; audioStatus.textContent='üîá Disconnected'; teardown(); }); socket.on('no-host', () => { audioStatus.textContent='‚ùå No host'; flash('No host streaming','error'); enableBtn.style.display='inline-block'; }); socket.on('host-left', () => { audioStatus.textContent='üîá Host left'; flash('Host left','error'); teardown(); }); socket.on('host-streaming', () => { if(enableBtn.style.display==='none') socket.emit('viewer-join'); }); socket.on('webrtc-offer', async ({ sdp, hostId }) => { hostIdRef = hostId; await ensurePeer(); await pc.setRemoteDescription(new RTCSessionDescription(sdp)); const answer = await pc.createAnswer(); await pc.setLocalDescription(answer); socket.emit('webrtc-answer', { hostId, sdp: answer }); }); socket.on('webrtc-ice-candidate', ({ candidate, from }) => { if(pc && candidate && from === hostIdRef) pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(()=>{}); }); socket.on('stats', ({ viewerCount }) => { clientsCount.textContent = `üë• ${viewerCount} listening`; }); }
            async function joinStream(){ enableBtn.style.display='none'; muteBtn.style.display='inline-block'; audioStatus.textContent='‚è≥ Joining...'; socket.emit('viewer-join'); flash('Request sent'); }
            async function ensurePeer(){ if(pc) return; pc = new RTCPeerConnection({ iceServers:[{ urls:'stun:stun.l.google.com:19302' }]}); pc.onicecandidate = e => { if(e.candidate && hostIdRef) socket.emit('webrtc-ice-candidate', { targetId: hostIdRef, candidate: e.candidate }); }; pc.ontrack = e => { if(!audioEl){ audioEl=document.createElement('audio'); audioEl.autoplay=true; audioEl.playsInline=true; audioEl.controls=false; audioEl.style.display='none'; audioEl.volume=volume; document.body.appendChild(audioEl); } audioEl.srcObject = e.streams[0]; const p = audioEl.play(); if(p) p.catch(()=>{ audioStatus.textContent='‚ö†Ô∏è Tap Enable Audio again'; }); audioStatus.textContent='üéµ Live'; animate(); }; pc.onconnectionstatechange = () => { if(['failed','disconnected','closed'].includes(pc.connectionState)) teardown(); }; }
            function toggleMute(){ muted=!muted; if(audioEl) audioEl.muted=muted; muteBtn.textContent = muted ? 'üîä Unmute' : 'üîá Mute'; }
            function teardown(){ if(pc){ pc.close(); pc=null; } if(audioEl){ audioEl.srcObject=null; audioEl.remove(); audioEl=null; } bars.forEach(b=>b.style.height='20%'); enableBtn.style.display='inline-block'; muteBtn.style.display='none'; }
            function animate(){ const step = () => { if(!pc || !audioEl || audioEl.paused) return; bars.forEach(b => { b.style.height = (Math.random()*80+20)+'%'; }); requestAnimationFrame(step); }; requestAnimationFrame(step); updateStatsLoop(); }
                    async function updateStatsLoop(){
                        if(!pc) return;
                        try {
                            const stats = await pc.getStats();
                            let jitterMs='-', rttMs='-', bitrateKbps='-', packetsLost=0, packetsRecv=0, fractionLoss='-';
                            let inboundRtp; let prevBytes = updateStatsLoop._prevBytes || 0; let prevTime = updateStatsLoop._prevTime || performance.now();
                            let now = performance.now();
                            stats.forEach(r => {
                                if(r.type==='remote-inbound-rtp' && r.kind==='audio') { if(r.jitter) jitterMs=(r.jitter*1000).toFixed(1); if(r.packetsLost!=null) packetsLost=r.packetsLost; }
                                if(r.type==='inbound-rtp' && r.kind==='audio') { inboundRtp = r; if(r.packetsReceived!=null) packetsRecv = r.packetsReceived; }
                                if(r.type==='candidate-pair' && r.currentRoundTripTime !== undefined && r.nominated) rttMs=(r.currentRoundTripTime*1000).toFixed(0);
                            });
                            if(inboundRtp && inboundRtp.bytesReceived!=null){
                                const bytes = inboundRtp.bytesReceived;
                                const deltaBytes = bytes - prevBytes;
                                const deltaTime = now - prevTime; // ms
                                if(deltaTime > 0) bitrateKbps = ((deltaBytes * 8) / deltaTime).toFixed(1); // kbps (since ms denominator -> *1000 cancels, we leave as per ms*8 then /1000 implicit) but approximate
                                updateStatsLoop._prevBytes = bytes;
                                updateStatsLoop._prevTime = now;
                            }
                            if(packetsRecv>0) fractionLoss = ((packetsLost / (packetsLost + packetsRecv))*100).toFixed(1)+'%';
                            qualityStats.textContent = `‚è±Ô∏è rtt ${rttMs}ms ‚Ä¢ jitter ${jitterMs}ms ‚Ä¢ bitrate ${bitrateKbps}kbps ‚Ä¢ loss ${fractionLoss}`;
                            // Emit to host every second
                            socket.emit('listener-stats', { rttMs, jitterMs, bitrateKbps, fractionLoss, packetsLost, packetsRecv });
                        } catch(_){}
                        setTimeout(updateStatsLoop,1000);
                    }
            function flash(msg,type='success'){ note.textContent=msg; note.className=`notification ${type} show`; setTimeout(()=>note.classList.remove('show'),2500); }
        </script>
    </body>
</html>
