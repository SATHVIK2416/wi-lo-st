<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>üéß Audio Listener</title>
        <script src="/socket.io/socket.io.js"></script>
        <style>
            *{margin:0;padding:0;box-sizing:border-box}
            body{font-family:"Segoe UI",Tahoma,Verdana,sans-serif;background:#000;min-height:100vh;display:flex;align-items:center;justify-content:center;color:#e5e5e5}
            .listener-container{background:#0d0d0d;padding:40px 38px;border-radius:22px;box-shadow:0 0 0 1px #1c1c1c,0 0 0 4px #000;max-width:520px;width:92%;text-align:center;border:1px solid #161616}
            h1{font-size:2.8rem;margin-bottom:14px;letter-spacing:.5px;text-shadow:2px 3px 6px rgba(0,0,0,.25)}
            .status{font-size:1.25rem;margin:18px 0;padding:14px 18px;border-radius:14px;background:#121212;border:1px solid #1e1e1e}
            .connection-status{display:flex;justify-content:center;gap:18px;flex-wrap:wrap;margin-bottom:18px}
            .status-item{background:#141414;padding:10px 18px;border-radius:18px;font-size:.9rem;border:1px solid #1f1f1f;color:#9aa0b5}
            .audio-visualizer{width:100%;height:64px;background:#111;border-radius:36px;margin:18px 0;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid #1d1d1d}
            .visualizer-bar{width:4px;margin:0 1px;background:linear-gradient(to top,#303a80,#5460d9,#9aa8ff);border-radius:2px;height:20%;transition:height .12s linear}
            .volume-control{margin:14px 0 6px}
            .volume-slider{width:100%;height:6px;border-radius:3px;background:#1b1b1b;outline:none;appearance:none;-webkit-appearance:none;border:1px solid #252525}
            .volume-slider::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:#6d7dff;cursor:pointer;box-shadow:0 0 0 3px #232323}
            .btn{background:#111;color:#b7c2ff;border:1px solid #2a2a2a;padding:11px 24px;border-radius:14px;font-size:.9rem;cursor:pointer;transition:.25s;margin:4px 6px;min-width:140px}
            .btn:hover{background:#181818;transform:translateY(-2px);border-color:#343c6d}
            .info-text{font-size:.8rem;opacity:.85;line-height:1.45;margin-top:18px}
            a{color:#fff}
            .notification{position:fixed;top:18px;right:18px;background:#101d10;padding:12px 18px;border-radius:10px;transform:translateX(340px);transition:transform .3s ease;font-size:.8rem;box-shadow:0 0 0 1px #1c1c1c,0 4px 18px -6px rgba(0,0,0,.5);z-index:1000;color:#b2f5ba}
            .notification.show{transform:translateX(0)}
            .notification.error{background:#2a0f10;color:#ffb3b8}
            @media (max-width:640px){h1{font-size:2.1rem}.listener-container{padding:32px 26px}}
        </style>
    </head>
    <body>
        <div class="listener-container">
            <h1>üéß Audio Listener</h1>
            <div id="audioStatus" class="status">üîá Waiting for audio stream...</div>
            <div class="connection-status">
                <div id="connectionStatus" class="status-item">üîå Connecting...</div>
                <div id="clientsCount" class="status-item">üë• 0 listening</div>
                <div id="qualityStats" class="status-item" style="min-width:140px;">‚è±Ô∏è ‚Ä¶</div>
            </div>
            <div id="audioVisualizer" class="audio-visualizer"></div>
            <div class="volume-control">
                <label for="volumeSlider">üîä Volume</label><br />
                <input id="volumeSlider" type="range" class="volume-slider" min="0" max="100" value="100" />
                <div id="volumeDisplay">100%</div>
            </div>
            <div class="controls">
                <button id="enableAudio" class="btn">üîä Enable Audio</button>
                <button id="muteAudio" class="btn" style="display:none;">üîá Mute</button>
            </div>
            <div class="info-text">Ensure you're on the same WiFi as the host. Press Enable to join the live system audio stream.</div>
            <div class="info-text" style="margin-top:28px"><a href="/">‚Üê Back to Main App</a></div>
        </div>
        <div id="notification" class="notification"></div>
        <script>
            let socket, pc, audioEl, hostIdRef = null; const bars = []; let muted = false, volume = 1.0;
            const qs = id => document.getElementById(id);
            const audioStatus = qs('audioStatus'), connectionStatus = qs('connectionStatus'), clientsCount = qs('clientsCount'), vis = qs('audioVisualizer'), volumeSlider = qs('volumeSlider'), volumeDisplay = qs('volumeDisplay'), enableBtn = qs('enableAudio'), muteBtn = qs('muteAudio'), note = qs('notification'), qualityStats = qs('qualityStats');
            document.addEventListener('DOMContentLoaded', () => { initBars(); initSocket(); bindUi(); });
            function initBars(){ for(let i=0;i<40;i++){ const b=document.createElement('div'); b.className='visualizer-bar'; vis.appendChild(b); bars.push(b);} }
            function bindUi(){ volumeSlider.addEventListener('input', () => { volume = volumeSlider.value/100; volumeDisplay.textContent = volumeSlider.value + '%'; if(audioEl) audioEl.volume = volume; }); enableBtn.addEventListener('click', joinStream); muteBtn.addEventListener('click', toggleMute); }
            function initSocket(){ socket = io(); socket.on('connect', () => { connectionStatus.textContent='üü¢ Connected'; connectionStatus.style.color='#38a169'; }); socket.on('disconnect', () => { connectionStatus.textContent='üî¥ Disconnected'; connectionStatus.style.color='#e53e3e'; audioStatus.textContent='üîá Disconnected'; teardown(); }); socket.on('no-host', () => { audioStatus.textContent='‚ùå No host'; flash('No host streaming','error'); enableBtn.style.display='inline-block'; }); socket.on('host-left', () => { audioStatus.textContent='üîá Host left'; flash('Host left','error'); teardown(); }); socket.on('host-streaming', () => { if(enableBtn.style.display==='none') socket.emit('viewer-join'); }); socket.on('webrtc-offer', async ({ sdp, hostId }) => { hostIdRef = hostId; await ensurePeer(); await pc.setRemoteDescription(new RTCSessionDescription(sdp)); const answer = await pc.createAnswer(); await pc.setLocalDescription(answer); socket.emit('webrtc-answer', { hostId, sdp: answer }); }); socket.on('webrtc-ice-candidate', ({ candidate, from }) => { if(pc && candidate && from === hostIdRef) pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(()=>{}); }); socket.on('stats', ({ viewerCount }) => { clientsCount.textContent = `üë• ${viewerCount} listening`; }); }
            async function joinStream(){ enableBtn.style.display='none'; muteBtn.style.display='inline-block'; audioStatus.textContent='‚è≥ Joining...'; socket.emit('viewer-join'); flash('Request sent'); }
            async function ensurePeer(){ if(pc) return; pc = new RTCPeerConnection({ iceServers:[{ urls:'stun:stun.l.google.com:19302' }]}); pc.onicecandidate = e => { if(e.candidate && hostIdRef) socket.emit('webrtc-ice-candidate', { targetId: hostIdRef, candidate: e.candidate }); }; pc.ontrack = e => { if(!audioEl){ audioEl=document.createElement('audio'); audioEl.autoplay=true; audioEl.playsInline=true; audioEl.controls=false; audioEl.style.display='none'; audioEl.volume=volume; document.body.appendChild(audioEl); } audioEl.srcObject = e.streams[0]; const p = audioEl.play(); if(p) p.catch(()=>{ audioStatus.textContent='‚ö†Ô∏è Tap Enable Audio again'; }); audioStatus.textContent='üéµ Live'; animate(); }; pc.onconnectionstatechange = () => { if(['failed','disconnected','closed'].includes(pc.connectionState)) teardown(); }; }
            function toggleMute(){ muted=!muted; if(audioEl) audioEl.muted=muted; muteBtn.textContent = muted ? 'üîä Unmute' : 'üîá Mute'; }
            function teardown(){ if(pc){ pc.close(); pc=null; } if(audioEl){ audioEl.srcObject=null; audioEl.remove(); audioEl=null; } bars.forEach(b=>b.style.height='20%'); enableBtn.style.display='inline-block'; muteBtn.style.display='none'; }
            function animate(){ const step = () => { if(!pc || !audioEl || audioEl.paused) return; bars.forEach(b => { b.style.height = (Math.random()*80+20)+'%'; }); requestAnimationFrame(step); }; requestAnimationFrame(step); updateStatsLoop(); }
                    async function updateStatsLoop(){
                        if(!pc) return;
                        try {
                            const stats = await pc.getStats();
                            let jitterMs='-', rttMs='-', bitrateKbps='-', packetsLost=0, packetsRecv=0, fractionLoss='-';
                            let inboundRtp; let prevBytes = updateStatsLoop._prevBytes || 0; let prevTime = updateStatsLoop._prevTime || performance.now();
                            let now = performance.now();
                            stats.forEach(r => {
                                if(r.type==='remote-inbound-rtp' && r.kind==='audio') { if(r.jitter) jitterMs=(r.jitter*1000).toFixed(1); if(r.packetsLost!=null) packetsLost=r.packetsLost; }
                                if(r.type==='inbound-rtp' && r.kind==='audio') { inboundRtp = r; if(r.packetsReceived!=null) packetsRecv = r.packetsReceived; }
                                if(r.type==='candidate-pair' && r.currentRoundTripTime !== undefined && r.nominated) rttMs=(r.currentRoundTripTime*1000).toFixed(0);
                            });
                            if(inboundRtp && inboundRtp.bytesReceived!=null){
                                const bytes = inboundRtp.bytesReceived;
                                const deltaBytes = bytes - prevBytes;
                                const deltaTime = now - prevTime; // ms
                                if(deltaTime > 0) bitrateKbps = ((deltaBytes * 8) / deltaTime).toFixed(1); // kbps (since ms denominator -> *1000 cancels, we leave as per ms*8 then /1000 implicit) but approximate
                                updateStatsLoop._prevBytes = bytes;
                                updateStatsLoop._prevTime = now;
                            }
                            if(packetsRecv>0) fractionLoss = ((packetsLost / (packetsLost + packetsRecv))*100).toFixed(1)+'%';
                            qualityStats.textContent = `‚è±Ô∏è rtt ${rttMs}ms ‚Ä¢ jitter ${jitterMs}ms ‚Ä¢ bitrate ${bitrateKbps}kbps ‚Ä¢ loss ${fractionLoss}`;
                            // Emit to host every second
                            socket.emit('listener-stats', { rttMs, jitterMs, bitrateKbps, fractionLoss, packetsLost, packetsRecv });
                        } catch(_){}
                        setTimeout(updateStatsLoop,1000);
                    }
            function flash(msg,type='success'){ note.textContent=msg; note.className=`notification ${type} show`; setTimeout(()=>note.classList.remove('show'),2500); }
        </script>
    </body>
</html>
