<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Live Audio Share ¬∑ Listener</title>
        <script src="/socket.io/socket.io.js"></script>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            :root {
                --bg: #050505;
                --gradient-1: rgba(99, 102, 241, 0.35);
                --gradient-2: rgba(16, 185, 129, 0.25);
                --surface: rgba(17, 17, 17, 0.82);
                --surface-strong: rgba(23, 23, 23, 0.9);
                --stroke: rgba(255, 255, 255, 0.08);
                --stroke-muted: rgba(255, 255, 255, 0.05);
                --accent: #6366f1;
                --accent-soft: rgba(99, 102, 241, 0.14);
                --accent-strong: #a5b4fc;
                --success: #10b981;
                --danger: #ef4444;
                --warn: #f59e0b;
                --text: #f9fafb;
                --text-muted: rgba(248, 250, 252, 0.72);
                --text-subtle: rgba(248, 250, 252, 0.48);
                --shadow: 0 36px 120px -42px rgba(0, 0, 0, 0.75);
                --transition: 200ms ease;
                font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
            }
            body {
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                background: radial-gradient(120% 120% at 50% -10%, var(--gradient-1), transparent 55%), radial-gradient(140% 140% at 100% 0%, var(--gradient-2), transparent 60%), var(--bg);
                color: var(--text);
                padding: 48px 24px;
                position: relative;
                overflow: hidden;
            }
            .orb {
                position: fixed;
                width: 420px;
                height: 420px;
                border-radius: 50%;
                filter: blur(55px);
                opacity: 0.75;
                pointer-events: none;
                animation: float 18s ease-in-out infinite;
                mix-blend-mode: screen;
            }
            .orb--one {
                background: radial-gradient(circle, rgba(99, 102, 241, 0.22), transparent 70%);
                top: -160px;
                left: -120px;
            }
            .orb--two {
                background: radial-gradient(circle, rgba(16, 185, 129, 0.22), transparent 70%);
                bottom: -140px;
                right: -140px;
                animation-delay: -6s;
            }
            .shell {
                width: min(640px, 100%);
                display: flex;
                flex-direction: column;
                gap: 28px;
                position: relative;
            }
            .panel {
                position: relative;
                border-radius: 26px;
                border: 1px solid var(--stroke);
                background: var(--surface);
                backdrop-filter: blur(22px);
                box-shadow: var(--shadow);
                padding: 32px clamp(24px, 5vw, 36px);
                animation: fadeUp 0.8s ease both;
            }
            .panel::after {
                content: "";
                position: absolute;
                inset: 0;
                border-radius: inherit;
                background: linear-gradient(120deg, rgba(99, 102, 241, 0.18) 0%, rgba(147, 197, 253, 0.08) 45%, transparent 90%);
                opacity: 0;
                transition: opacity var(--transition);
                pointer-events: none;
            }
            .panel:hover::after { opacity: 1; }
            .panel--hero {
                display: grid;
                gap: 18px;
                justify-items: center;
                text-align: center;
            }
            .hero-icon {
                width: 68px;
                height: 68px;
                border-radius: 22px;
                background: var(--accent-soft);
                display: grid;
                place-items: center;
                font-size: 2rem;
                color: var(--accent);
                box-shadow: 0 22px 40px -28px rgba(99, 102, 241, 0.85);
            }
            .panel--hero h1 {
                font-size: clamp(2.2rem, 5vw, 2.6rem);
                letter-spacing: -0.02em;
                font-weight: 700;
            }
            .hero-copy {
                max-width: 460px;
                color: var(--text-muted);
                line-height: 1.7;
                font-size: 1.02rem;
            }
            .chip-row {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                justify-content: center;
            }
            .chip {
                padding: 10px 16px;
                border-radius: 999px;
                border: 1px solid var(--stroke-muted);
                background: rgba(12, 12, 12, 0.55);
                color: var(--text-subtle);
                font-size: 0.9rem;
                transition: background var(--transition), border-color var(--transition), color var(--transition);
            }
            .chip--ok {
                border-color: rgba(16, 185, 129, 0.45);
                color: var(--text);
                background: rgba(16, 185, 129, 0.18);
            }
            .chip--warn {
                border-color: rgba(245, 158, 11, 0.45);
                color: #fcd34d;
                background: rgba(245, 158, 11, 0.18);
            }
            .chip--error {
                border-color: rgba(239, 68, 68, 0.45);
                color: #fecaca;
                background: rgba(239, 68, 68, 0.18);
            }
            .panel--player { display: flex; flex-direction: column; gap: 22px; }
            .badge {
                align-self: center;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: 10px 18px;
                border-radius: 999px;
                border: 1px solid var(--stroke);
                text-transform: uppercase;
                letter-spacing: 0.12em;
                font-size: 0.78rem;
                color: var(--text-subtle);
                background: rgba(255, 255, 255, 0.04);
                transition: background var(--transition), border-color var(--transition), color var(--transition);
            }
            .badge--idle { background: rgba(255, 255, 255, 0.04); }
            .badge--live {
                background: rgba(99, 102, 241, 0.24);
                border-color: rgba(99, 102, 241, 0.5);
                color: var(--text);
            }
            .badge--error {
                background: rgba(239, 68, 68, 0.22);
                border-color: rgba(239, 68, 68, 0.45);
                color: #fecaca;
            }
            .visualizer {
                position: relative;
                height: 110px;
                border-radius: 20px;
                border: 1px solid var(--stroke);
                overflow: hidden;
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.18), rgba(16, 185, 129, 0.12));
                display: flex;
                align-items: flex-end;
                gap: 4px;
                padding: 14px 16px;
                transition: border-color var(--transition), box-shadow var(--transition);
            }
            .visualizer::after {
                content: "";
                position: absolute;
                inset: 0;
                pointer-events: none;
                background: linear-gradient(120deg, rgba(99, 102, 241, 0.32), rgba(16, 185, 129, 0.22));
                opacity: 0;
                transition: opacity 0.25s ease;
            }
            .visualizer.is-live::after { opacity: 0.45; }
            .visualizer-bar {
                flex: 1;
                border-radius: 6px;
                background: linear-gradient(to top, rgba(99, 102, 241, 0.88), rgba(129, 140, 248, 0.78));
                height: 18%;
                transition: height 0.18s ease-out;
                filter: drop-shadow(0 0 12px rgba(99, 102, 241, 0.4));
            }
            .panel__grid { display: grid; gap: 24px; }
            .volume-card {
                border-radius: 18px;
                border: 1px solid var(--stroke-muted);
                background: rgba(12, 12, 12, 0.55);
                padding: 22px;
                display: flex;
                flex-direction: column;
                gap: 14px;
            }
            .volume-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .volume-label {
                font-size: 0.78rem;
                letter-spacing: 0.14em;
                text-transform: uppercase;
                color: var(--text-subtle);
            }
            .volume-value {
                font-size: 1.05rem;
                font-weight: 600;
                color: var(--accent-strong);
            }
            .slider {
                width: 100%;
                height: 6px;
                border-radius: 999px;
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid var(--stroke);
                appearance: none;
                outline: none;
                transition: box-shadow var(--transition);
            }
            .slider::-webkit-slider-thumb {
                appearance: none;
                width: 18px;
                height: 18px;
                border-radius: 50%;
                background: var(--accent);
                border: none;
                box-shadow: 0 0 0 6px rgba(99, 102, 241, 0.18);
                transition: transform var(--transition), box-shadow var(--transition);
            }
            .slider::-webkit-slider-thumb:hover {
                transform: scale(1.08);
                box-shadow: 0 0 0 8px rgba(99, 102, 241, 0.24);
            }
            .slider::-moz-range-thumb {
                width: 18px;
                height: 18px;
                border-radius: 50%;
                background: var(--accent);
                border: none;
                box-shadow: 0 0 0 6px rgba(99, 102, 241, 0.18);
                transition: transform var(--transition), box-shadow var(--transition);
            }
            .slider::-moz-range-thumb:hover {
                transform: scale(1.08);
                box-shadow: 0 0 0 8px rgba(99, 102, 241, 0.24);
            }
            .slider:focus-visible { box-shadow: 0 0 0 6px rgba(99, 102, 241, 0.18); }
            .control-row {
                display: flex;
                gap: 12px;
                flex-wrap: wrap;
                justify-content: center;
            }
            .btn {
                appearance: none;
                border: 1px solid transparent;
                border-radius: 999px;
                padding: 12px 26px;
                font-size: 0.98rem;
                font-weight: 600;
                letter-spacing: 0.01em;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                cursor: pointer;
                transition: transform var(--transition), box-shadow var(--transition), border-color var(--transition), background var(--transition);
                backdrop-filter: blur(8px);
            }
            .btn-primary {
                background: linear-gradient(135deg, var(--accent), #8b5cf6);
                color: var(--text);
                box-shadow: 0 24px 46px -28px rgba(99, 102, 241, 0.92);
            }
            .btn-primary:hover { transform: translateY(-3px); }
            .btn-ghost {
                background: rgba(255, 255, 255, 0.05);
                border-color: var(--stroke);
                color: var(--text);
            }
            .btn-ghost:hover {
                background: rgba(255, 255, 255, 0.12);
                border-color: rgba(99, 102, 241, 0.4);
                transform: translateY(-2px);
            }
            .callout {
                border-radius: 18px;
                border: 1px solid rgba(99, 102, 241, 0.24);
                background: rgba(99, 102, 241, 0.08);
                padding: 18px 20px;
                color: var(--text-subtle);
                font-size: 0.92rem;
                line-height: 1.65;
                text-align: center;
            }
            .link-back {
                justify-self: center;
                color: var(--text-muted);
                text-decoration: none;
                font-size: 0.9rem;
                display: inline-flex;
                gap: 6px;
                align-items: center;
                transition: color var(--transition);
            }
            .link-back:hover { color: var(--accent-strong); }
            .notification {
                position: fixed;
                bottom: 32px;
                right: 32px;
                padding: 18px 24px;
                border-radius: 18px;
                border: 1px solid var(--stroke);
                background: rgba(12, 12, 12, 0.88);
                color: var(--text);
                box-shadow: var(--shadow);
                transform: translateX(120%);
                transition: transform 260ms cubic-bezier(0.35, 0.7, 0.4, 1);
                display: flex;
                align-items: center;
                gap: 12px;
                z-index: 1000;
                backdrop-filter: blur(18px);
            }
            .notification::before {
                content: "";
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: var(--success);
                box-shadow: 0 0 14px rgba(16, 185, 129, 0.6);
            }
            .notification.error::before {
                background: var(--danger);
                box-shadow: 0 0 14px rgba(239, 68, 68, 0.65);
            }
            .notification.show { transform: translateX(0); }
            a { color: inherit; }
            @keyframes fadeUp {
                0% { opacity: 0; transform: translateY(18px); }
                100% { opacity: 1; transform: translateY(0); }
            }
            @keyframes float {
                0% { transform: translate3d(-10%, -6%, 0) scale(1); }
                50% { transform: translate3d(8%, 6%, 0) scale(1.04); }
                100% { transform: translate3d(-10%, -6%, 0) scale(1); }
            }
            @media (max-width: 560px) {
                body { padding: 32px 18px; }
                .panel { padding: 28px 22px; }
                .control-row { flex-direction: column; }
                .btn { width: 100%; }
            }
            @media (prefers-reduced-motion: reduce) {
                *, *::before, *::after {
                    animation-duration: 0.01ms !important;
                    animation-iteration-count: 1 !important;
                    transition-duration: 0.01ms !important;
                }
            }
        </style>
    </head>
    <body>
        <div class="orb orb--one"></div>
        <div class="orb orb--two"></div>
        <main class="shell">
            <header class="panel panel--hero">
                <div class="hero-icon">üéß</div>
                <div>
                    <h1>Audio Listener</h1>
                    <p class="hero-copy">A minimal player for tapping into the host's hi-fi stream with zero fuss.</p>
                </div>
                <div class="chip-row">
                    <span id="connectionStatus" class="chip chip--status">üîå Connecting...</span>
                    <span id="clientsCount" class="chip chip--status">üë• 0 listening</span>
                    <span id="qualityStats" class="chip chip--status">‚è±Ô∏è ...</span>
                </div>
            </header>
            <section class="panel panel--player">
                <div id="audioStatus" class="badge badge--idle">üîá Waiting for audio stream...</div>
                <div id="audioVisualizer" class="visualizer"></div>
                <div class="panel__grid">
                    <div class="volume-card">
                        <div class="volume-header">
                            <span class="volume-label">Volume</span>
                            <span id="volumeDisplay" class="volume-value">100%</span>
                        </div>
                        <input id="volumeSlider" type="range" class="slider" min="0" max="100" value="100" />
                    </div>
                    <div class="control-row">
                        <button id="enableAudio" class="btn btn-primary">üîä Enable Audio</button>
                        <button id="muteAudio" class="btn btn-ghost" style="display:none;">üîá Mute</button>
                    </div>
                    <div class="callout">Stay on the same network as the host, tap Enable, then leave this tab running in the background.</div>
                    <a href="/" class="link-back">‚Üê Back to Host Console</a>
                </div>
            </section>
        </main>
        <div id="notification" class="notification"></div>
        <script>
            let socket, pc, audioEl, hostIdRef = null; const bars = []; let muted = false, volume = 1.0;
            const qs = id => document.getElementById(id);
            const audioStatus = qs('audioStatus'), connectionStatus = qs('connectionStatus'), clientsCount = qs('clientsCount'), vis = qs('audioVisualizer'), volumeSlider = qs('volumeSlider'), volumeDisplay = qs('volumeDisplay'), enableBtn = qs('enableAudio'), muteBtn = qs('muteAudio'), note = qs('notification'), qualityStats = qs('qualityStats');
            const setChipState = (el, state) => {
                if(!el) return;
                el.classList.remove('chip--ok','chip--warn','chip--error');
                if(state) el.classList.add(`chip--${state}`);
            };
            const setAudioBadge = (message, state = 'idle') => {
                audioStatus.textContent = message;
                audioStatus.classList.remove('badge--idle','badge--live','badge--error');
                audioStatus.classList.add(state === 'live' ? 'badge--live' : state === 'error' ? 'badge--error' : 'badge--idle');
            };
            document.addEventListener('DOMContentLoaded', () => { initBars(); initSocket(); bindUi(); setAudioBadge('üîá Waiting for audio stream...'); });
            function initBars(){ for(let i=0;i<40;i++){ const b=document.createElement('div'); b.className='visualizer-bar'; vis.appendChild(b); bars.push(b);} }
            function bindUi(){ volumeSlider.addEventListener('input', () => { volume = volumeSlider.value/100; volumeDisplay.textContent = volumeSlider.value + '%'; if(audioEl) audioEl.volume = volume; }); enableBtn.addEventListener('click', joinStream); muteBtn.addEventListener('click', toggleMute); }
            function initSocket(){
                socket = io();
                socket.on('connect', () => { setChipState(connectionStatus,'ok'); connectionStatus.textContent='üü¢ Connected'; });
                socket.on('disconnect', () => { setChipState(connectionStatus,'error'); connectionStatus.textContent='üî¥ Disconnected'; setAudioBadge('üîá Disconnected','error'); teardown(); });
                socket.on('no-host', () => { setAudioBadge('‚ùå No host','error'); flash('No host streaming','error'); enableBtn.style.display='inline-flex'; });
                socket.on('host-left', () => { setAudioBadge('üîá Host left','error'); flash('Host left','error'); teardown(); });
                socket.on('host-stopped', () => { setAudioBadge('üîá Waiting for audio stream...','idle'); flash('Host stopped streaming','error'); teardown(); });
                socket.on('host-streaming', () => { if(enableBtn.style.display==='none') socket.emit('viewer-join'); });
                socket.on('webrtc-offer', async ({ sdp, hostId }) => { hostIdRef = hostId; await ensurePeer(); await pc.setRemoteDescription(new RTCSessionDescription(sdp)); const answer = await pc.createAnswer(); await pc.setLocalDescription(answer); socket.emit('webrtc-answer', { hostId, sdp: answer }); });
                socket.on('webrtc-ice-candidate', ({ candidate, from }) => { if(pc && candidate && from === hostIdRef) pc.addIceCandidate(new RTCIceCandidate(candidate)).catch(()=>{}); });
                socket.on('stats', ({ viewerCount }) => { clientsCount.textContent = `üë• ${viewerCount} listening`; });
            }
            async function joinStream(){ enableBtn.style.display='none'; muteBtn.style.display='inline-flex'; setAudioBadge('‚è≥ Joining...','idle'); socket.emit('viewer-join'); flash('Request sent'); }
            async function ensurePeer(){
                if(pc) return;
                pc = new RTCPeerConnection({ iceServers:[{ urls:'stun:stun.l.google.com:19302' }]});
                pc.onicecandidate = e => { if(e.candidate && hostIdRef) socket.emit('webrtc-ice-candidate', { targetId: hostIdRef, candidate: e.candidate }); };
                pc.ontrack = e => {
                    if(!audioEl){ audioEl=document.createElement('audio'); audioEl.autoplay=true; audioEl.playsInline=true; audioEl.controls=false; audioEl.style.display='none'; audioEl.volume=volume; document.body.appendChild(audioEl); }
                    audioEl.srcObject = e.streams[0];
                    const p = audioEl.play();
                    if(p) p.catch(()=>{ setAudioBadge('‚ö†Ô∏è Tap Enable Audio again','error'); });
                    setAudioBadge('üéµ Live','live');
                    vis.classList.add('is-live');
                    animate();
                };
                pc.onconnectionstatechange = () => { if(['failed','disconnected','closed'].includes(pc.connectionState)) teardown(); };
            }
            function toggleMute(){ muted=!muted; if(audioEl) audioEl.muted=muted; muteBtn.textContent = muted ? 'üîä Unmute' : 'üîá Mute'; }
            function teardown(){
                if(pc){ pc.close(); pc=null; }
                if(audioEl){ audioEl.srcObject=null; audioEl.remove(); audioEl=null; }
                bars.forEach(b=>b.style.height='18%');
                enableBtn.style.display='inline-flex';
                muteBtn.style.display='none';
                vis.classList.remove('is-live');
                setAudioBadge('üîá Waiting for audio stream...','idle');
            }
            function animate(){
                const step = () => {
                    if(!pc || !audioEl || audioEl.paused){ vis.classList.remove('is-live'); return; }
                    bars.forEach(b => { b.style.height = (Math.random()*80+20)+'%'; });
                    requestAnimationFrame(step);
                };
                requestAnimationFrame(step);
                updateStatsLoop();
            }
            async function updateStatsLoop(){
                if(!pc) return;
                try {
                    const stats = await pc.getStats();
                    let jitterMs='-', rttMs='-', bitrateKbps='-', packetsLost=0, packetsRecv=0, fractionLoss='-';
                    let inboundRtp; let prevBytes = updateStatsLoop._prevBytes || 0; let prevTime = updateStatsLoop._prevTime || performance.now();
                    const now = performance.now();
                    stats.forEach(r => {
                        if(r.type==='remote-inbound-rtp' && r.kind==='audio') { if(r.jitter) jitterMs=(r.jitter*1000).toFixed(1); if(r.packetsLost!=null) packetsLost=r.packetsLost; }
                        if(r.type==='inbound-rtp' && r.kind==='audio') { inboundRtp = r; if(r.packetsReceived!=null) packetsRecv = r.packetsReceived; }
                        if(r.type==='candidate-pair' && r.currentRoundTripTime !== undefined && r.nominated) rttMs=(r.currentRoundTripTime*1000).toFixed(0);
                    });
                    if(inboundRtp && inboundRtp.bytesReceived!=null){
                        const bytes = inboundRtp.bytesReceived;
                        const deltaBytes = bytes - prevBytes;
                        const deltaTime = now - prevTime;
                        if(deltaTime > 0) bitrateKbps = ((deltaBytes * 8) / deltaTime).toFixed(1);
                        updateStatsLoop._prevBytes = bytes;
                        updateStatsLoop._prevTime = now;
                    }
                    if(packetsRecv>0) fractionLoss = ((packetsLost / (packetsLost + packetsRecv))*100).toFixed(1)+'%';
                    qualityStats.textContent = `‚è±Ô∏è rtt ${rttMs}ms ‚Ä¢ jitter ${jitterMs}ms ‚Ä¢ bitrate ${bitrateKbps}kbps ‚Ä¢ loss ${fractionLoss}`;
                    const lossValue = parseFloat(fractionLoss) || 0;
                    const rttValue = parseFloat(rttMs) || 0;
                    let qualityState = 'ok';
                    if(lossValue > 5 || rttValue > 250) qualityState = 'error';
                    else if(lossValue > 2 || rttValue > 150) qualityState = 'warn';
                    setChipState(qualityStats, qualityState);
                    socket.emit('listener-stats', { rttMs, jitterMs, bitrateKbps, fractionLoss, packetsLost, packetsRecv });
                } catch(_){ }
                setTimeout(updateStatsLoop,1000);
            }
            function flash(msg,type='success'){ note.textContent=msg; note.className=`notification ${type} show`; setTimeout(()=>note.classList.remove('show'),2500); }
        </script>
    </body>
</html>
